---
title: "情景记忆管理器"
description: "调用 Episodic Memory Manager 的 API"
icon: "list-check"
---
`EpisodicMemoryManager` 是整个情景记忆系统的大脑。它以 **单例** 形式存在，既充当工厂，又提供一组方法，帮助你在任何会话语境中安全地创建与访问记忆实例。

### 核心职责

- **注册表：** 追踪所有活跃的 `EpisodicMemory` 实例，确保每个唯一的 group、agent、user、session 组合都拥有独立记忆。
- **生命周期控制：** 负责从创建到安全关闭的全流程管理，通过引用计数避免过早清理。
- **会话管理：** 与底层存储交互，持久化群组和会话的元数据（参与者、会话设置等）。
- **配置管理：** 平滑加载并合并全局配置与会话级特定配置。

## 初始化与访问

你无需直接实例化管理器，而是通过主客户端对象获取它的单例实例。

```python
from memmachine import MemMachineClient

# 使用 API Key 初始化客户端
client = MemMachineClient(api_key="your_api_key")

# 访问管理器实例
manager = client.episodic_memory_manager
```

## `EpisodicMemoryManager` 类

```python
class EpisodicMemoryManager()
```

负责创建并管理 `EpisodicMemory` 实例的生命周期，既是工厂也是中央注册中心。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.create_episodic_memory_manager"></a>

### create_episodic_memory_manager

```python
@classmethod
def create_episodic_memory_manager(cls, config_path: str)
```

用于创建并初始化管理器实例的单例工厂方法。该方法负责读取配置文件、设置日志以及加载默认提示词。

**参数：**

- `config_path`：主配置文件路径（例如 `memmachine.yaml`）。

**返回值：**

共享的 `EpisodicMemoryManager` 单例实例。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.create_group"></a>

### create_group

```python
async def create_group(self, group_id: str,
                       agent_ids: list[str] | None,
                       user_ids: list[str] | None)
```

在系统中注册一个新的会话群组。**群组** 定义了可以参与该会话的固定成员（用户与智能体）。在创建会话之前必须先创建群组。

**参数：**

- `group_id`：群组唯一 ID（例如 `"team_alpha"`）。
- `agent_ids`：属于该群组的智能体 ID 列表。
- `user_ids`：属于该群组的用户 ID 列表。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.create_episodic_memory_instance"></a>

### create_episodic_memory_instance

```python
async def create_episodic_memory_instance(
        self,
        group_id: str,
        session_id: str,
        configuration: dict | None = None
) -> EpisodicMemory
```

创建**全新的会话**及对应的 `EpisodicMemory` 实例。若该 `group_id` 下已存在同名 `session_id`，调用将失败。

**参数：**

- `group_id`：会话所属群组 ID（需已存在）。
- `session_id`：新会话的唯一标识。
- `configuration`：*可选。* 会话级配置字典，用于覆盖管理器默认设置。

**返回值：**

初始化完成、可直接使用的 `EpisodicMemory` 实例。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.open_episodic_memory_instance"></a>

### open_episodic_memory_instance

```python
async def open_episodic_memory_instance(
    self,
    group_id: str,
    session_id: str
) -> EpisodicMemory
```

打开**已存在的会话**并返回对应的 `EpisodicMemory` 实例。若该实例已被其他组件使用，会安全地增加引用计数并共享该实例。

**参数：**

- `group_id`：群组 ID。
- `session_id`：已有会话的 ID。

**返回值：**

指定上下文下的活跃 `EpisodicMemory` 实例。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.async_open_episodic_memory_instance"></a>

### async_open_episodic_memory_instance (Recommended)

```python
@asynccontextmanager
async def async_open_episodic_memory_instance(
    self,
    group_id: str,
    session_id: str,
)
```

使用 Python 的 `async with` 语法为记忆实例提供安全的生命周期管理，这是与现有记忆交互的**推荐方式**。

**进入上下文时自动调用 `open_episodic_memory_instance`，退出时调用 `instance.close()`，**确保引用计数被正确维护。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.async_create_episodic_memory_instance"></a>

### async_create_episodic_memory_instance (Recommended)

```python
@asynccontextmanager
async def async_create_episodic_memory_instance(
    self,
    group_id: str,
    session_id: str,
    configuration: dict | None = None
)
```

与 `async_open_episodic_memory_instance` 类似，但用于**创建新的记忆实例**。上下文结束时会确保资源被安全释放。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.get_episodic_memory_instance"></a>

### get_episodic_memory_instance

```python
async def get_episodic_memory_instance(
    self,
    group_id: str,
    agent_id: list[str] | None = None,
    user_id: list[str] | None = None,
    session_id: str = "",
    configuration: dict | None = None,
) -> EpisodicMemory | None
```

一个兼容性较强的通用方法，用于获取记忆实例；若会话不存在，会尝试依据给定的用户/智能体 ID 自动创建。

**注意：** 如需显式控制会话是否存在，建议改用 `create_episodic_memory_instance` 或 `open_episodic_memory_instance`。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.close_episodic_memory_instance"></a>

### close_episodic_memory_instance

```python
async def close_episodic_memory_instance(
    self,
    group_id: str,
    session_id: str,
) -> bool
```

手动关闭活跃记忆实例，会调用 `instance.close()` 并减少引用计数；若这是最后一个引用，将从管理器的注册表中移除该实例。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.delete_context_memory"></a>

### delete_context_memory

```python
async def delete_context_memory(self, context: MemoryContext)
```

**仅供内部使用。** 从管理器内部注册表中移除指定 `EpisodicMemory` 实例，应由实例自身在引用计数归零时调用。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.shut_down"></a>

### shut_down

```python
async def shut\_down(self)
```

安全关闭整个管理器，遍历所有活跃的 `EpisodicMemory` 实例并强制关闭，确保资源彻底释放。

<a id="memmachine.episodic_memory_manager.EpisodicMemoryManager.get_group_configuration"></a>

### get_group_configuration

```python
def get_group_configuration(self, group_id: str) -> GroupConfiguration | None
```
